<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Model Viewer Test - Minimal</title>
  
  <!-- Load model-viewer from jsdelivr CDN with pinned stable version -->
  <!-- Using v3.5.0 for better browser compatibility -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer@3.5.0/dist/model-viewer.min.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    
    h1 {
      color: #333;
    }
    
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    model-viewer {
      width: 100%;
      height: 400px;
      background: #eee;
      border: 2px solid #ccc;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    
    .status.loading { background: #fff3cd; color: #856404; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    
    .log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      border-radius: 4px;
    }
    
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      background: #0d2c57;
      color: white;
      border: none;
      border-radius: 4px;
    }
    
    button:hover {
      background: #1a4a8a;
    }
  </style>
</head>
<body>
  <h1>üîß Model Viewer Test Page</h1>
  <p>This page tests if model-viewer and 3D models load correctly.</p>
  
  <div class="test-section">
    <h2>Test 1: Model-Viewer Library Status</h2>
    <div id="library-status" class="status loading">‚è≥ Checking if model-viewer library loaded...</div>
  </div>
  
  <div class="test-section">
    <h2>Test 2: Model Loading (Maschine-Kopie.glb)</h2>
    <div id="model-status" class="status loading">‚è≥ Loading model...</div>
    
    <model-viewer
      id="test-viewer"
      src="Maschine-Kopie.glb"
      ios-src="Maschine-Kopie.usdz"
      camera-controls
      auto-rotate
      shadow-intensity="1"
      alt="Test 3D Model">
      <div slot="poster" style="display:flex;align-items:center;justify-content:center;height:100%;background:#ddd;">
        ‚è≥ Loading 3D Model (~50MB)...
      </div>
    </model-viewer>
  </div>
  
  <div class="test-section">
    <h2>Test 3: Console Log</h2>
    <div id="console-log" class="log">Waiting for events...</div>
  </div>
  
  <div class="test-section">
    <h2>Test 4: Manual Tests</h2>
    <button onclick="testModelFile()">Test Model File Access</button>
    <button onclick="testCDN()">Test CDN Access</button>
    <button onclick="reloadModel()">Reload Model</button>
    <button onclick="clearLog()">Clear Log</button>
    <div id="manual-test-result" class="status" style="display:none;"></div>
  </div>
  
  <div class="test-section">
    <h2>Debug Info</h2>
    <ul>
      <li><strong>Page URL:</strong> <span id="page-url"></span></li>
      <li><strong>Model URL:</strong> <span id="model-url"></span></li>
      <li><strong>Browser:</strong> <span id="browser-info"></span></li>
      <li><strong>model-viewer version:</strong> <span id="mv-version">Checking...</span></li>
    </ul>
  </div>

  <script>
    // Logging utility
    function log(message, type = 'info') {
      const logDiv = document.getElementById('console-log');
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type}] ${message}`);
    }
    
    function clearLog() {
      document.getElementById('console-log').textContent = 'Log cleared.\n';
    }
    
    // Fill in debug info
    document.getElementById('page-url').textContent = window.location.href;
    document.getElementById('model-url').textContent = window.location.origin + '/Maschine-Kopie.glb';
    document.getElementById('browser-info').textContent = navigator.userAgent.split(' ').slice(-2).join(' ');
    
    // Test 1: Check if model-viewer library loaded
    function checkLibrary() {
      const statusDiv = document.getElementById('library-status');
      if (window.customElements.get('model-viewer')) {
        statusDiv.className = 'status success';
        statusDiv.textContent = '‚úÖ model-viewer library loaded successfully!';
        log('model-viewer library is loaded', 'success');
        
        // Try to get version
        try {
          const mv = document.querySelector('model-viewer');
          if (mv && mv.constructor && mv.constructor.version) {
            document.getElementById('mv-version').textContent = mv.constructor.version;
          } else {
            document.getElementById('mv-version').textContent = 'Unknown (loaded)';
          }
        } catch(e) {
          document.getElementById('mv-version').textContent = 'Unknown';
        }
        return true;
      } else {
        statusDiv.className = 'status error';
        statusDiv.textContent = '‚ùå model-viewer library NOT loaded - CDN may be blocked';
        log('model-viewer library NOT loaded - check if CDN is blocked', 'error');
        return false;
      }
    }
    
    // Check library after short delay
    setTimeout(checkLibrary, 1000);
    // Check again after longer delay in case of slow load
    setTimeout(checkLibrary, 5000);
    
    // Test 2: Model loading events
    const viewer = document.getElementById('test-viewer');
    const modelStatus = document.getElementById('model-status');
    
    viewer.addEventListener('load', () => {
      modelStatus.className = 'status success';
      modelStatus.textContent = '‚úÖ Model loaded successfully!';
      log('Model "load" event fired - model loaded!', 'success');
    });
    
    viewer.addEventListener('model-visibility', () => {
      log('Model "model-visibility" event fired - model is now visible', 'success');
    });
    
    viewer.addEventListener('error', (event) => {
      modelStatus.className = 'status error';
      
      // Detect Safari
      var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      
      // Check for empty sourceError which often indicates Safari WebGL context loss
      var hasEmptySourceError = event.detail && 
        (typeof event.detail === 'object') && 
        (Object.keys(event.detail.sourceError || {}).length === 0);
      
      if (isSafari && hasEmptySourceError) {
        modelStatus.textContent = '‚ùå Safari WebGL issue detected - see console log';
        log('Model "error" event fired!', 'error');
        log('‚ö†Ô∏è SAFARI WEBGL ISSUE DETECTED: Empty sourceError typically indicates WebGL context loss', 'error');
        log('This is a known Safari/WebKit bug. Try: reload page, clear cache, restart Safari, or use Chrome/Firefox', 'warn');
      } else {
        modelStatus.textContent = '‚ùå Model failed to load - see console log';
        log('Model "error" event fired!', 'error');
      }
      
      log('Error event: ' + JSON.stringify(event.detail || 'no details'), 'error');
      log('Model src: ' + viewer.src, 'error');
      log('Expected URL: ' + window.location.origin + '/' + viewer.src, 'error');
    });
    
    viewer.addEventListener('progress', (event) => {
      const progress = Math.round(event.detail.totalProgress * 100);
      modelStatus.textContent = `‚è≥ Loading model... ${progress}%`;
      if (progress % 25 === 0) { // Log every 25%
        log(`Model loading progress: ${progress}%`, 'info');
      }
    });
    
    // WebGL context loss detection for Safari
    (function setupWebGLContextLossDetection() {
      var checkInterval = setInterval(function() {
        try {
          if (viewer && viewer.shadowRoot) {
            var canvas = viewer.shadowRoot.querySelector('canvas');
            if (canvas) {
              clearInterval(checkInterval);
              canvas.addEventListener('webglcontextlost', function(e) {
                e.preventDefault();
                log('‚ö†Ô∏è WebGL CONTEXT LOST - This is a known Safari/WebKit bug', 'error');
                log('Solution: Reload page, clear Safari cache, or restart Safari', 'warn');
                modelStatus.className = 'status error';
                modelStatus.textContent = '‚ùå WebGL context lost (Safari bug) - reload page';
              });
              log('WebGL context loss detection enabled', 'info');
            }
          }
        } catch (e) {
          // Ignore errors during setup
        }
      }, 500);
      // Stop checking after 10 seconds
      setTimeout(function() { clearInterval(checkInterval); }, 10000);
    })();
    
    // Manual tests
    function testModelFile() {
      const resultDiv = document.getElementById('manual-test-result');
      resultDiv.style.display = 'block';
      resultDiv.className = 'status loading';
      resultDiv.textContent = '‚è≥ Testing model file access...';
      
      log('Testing direct model file access...', 'info');
      
      fetch('Maschine-Kopie.glb', { method: 'HEAD' })
        .then(response => {
          if (response.ok) {
            resultDiv.className = 'status success';
            resultDiv.textContent = `‚úÖ Model file accessible! Status: ${response.status}, Size: ${response.headers.get('content-length')} bytes`;
            log(`Model file accessible: ${response.status}, Size: ${response.headers.get('content-length')} bytes`, 'success');
            log(`Content-Type: ${response.headers.get('content-type')}`, 'info');
            log(`Cross-Origin-Resource-Policy: ${response.headers.get('cross-origin-resource-policy')}`, 'info');
          } else {
            resultDiv.className = 'status error';
            resultDiv.textContent = `‚ùå Model file error! Status: ${response.status}`;
            log(`Model file error: ${response.status} ${response.statusText}`, 'error');
          }
        })
        .catch(error => {
          resultDiv.className = 'status error';
          resultDiv.textContent = `‚ùå Fetch failed: ${error.message}`;
          log(`Fetch failed: ${error.message}`, 'error');
        });
    }
    
    function testCDN() {
      const resultDiv = document.getElementById('manual-test-result');
      resultDiv.style.display = 'block';
      resultDiv.className = 'status loading';
      resultDiv.textContent = '‚è≥ Testing CDN access...';
      
      log('Testing CDN access (unpkg.com)...', 'info');
      
      // Test unpkg
      fetch('https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js', { method: 'HEAD', mode: 'no-cors' })
        .then(() => {
          log('unpkg.com request completed (no-cors mode)', 'info');
        })
        .catch(error => {
          log(`unpkg.com fetch failed: ${error.message}`, 'error');
        });
      
      // Test jsdelivr
      fetch('https://cdn.jsdelivr.net/npm/@google/model-viewer/dist/model-viewer.min.js', { method: 'HEAD', mode: 'no-cors' })
        .then(() => {
          log('jsdelivr.net request completed (no-cors mode)', 'info');
          resultDiv.className = 'status success';
          resultDiv.textContent = '‚úÖ CDN requests completed - check console log for details';
        })
        .catch(error => {
          log(`jsdelivr.net fetch failed: ${error.message}`, 'error');
          resultDiv.className = 'status error';
          resultDiv.textContent = '‚ùå CDN access may be blocked';
        });
    }
    
    function reloadModel() {
      log('Reloading model...', 'info');
      const currentSrc = viewer.src;
      viewer.src = '';
      setTimeout(() => {
        viewer.src = currentSrc;
        modelStatus.className = 'status loading';
        modelStatus.textContent = '‚è≥ Reloading model...';
      }, 100);
    }
    
    // Log page load
    log('Test page loaded', 'info');
    log('Waiting for model-viewer library and model to load...', 'info');
  </script>
</body>
</html>
